<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="Content-type" content="text/html;charset=UTF-8">

	<title>GDG self-checkin</title>
	<link href='http://fonts.googleapis.com/css?family=Roboto' rel='stylesheet' type='text/css'>
	<!-- 
	<link href='/css/main.css' rel='stylesheet' type='text/css'>
 	-->
  </head>
  <body>




	<style type="text/css">




		html, body {
			margin: 0;
			padding: 0;
			width: 100%;
			height: 100%;
			overflow: hidden;
			font-family: Roboto;
			font-size: 100%;
			font-style: normal;
			background-color: #000;
			color: #fff;
			-webkit-font-smoothing: antialiased;
		}


		#logo {
			position: absolute;
			top: 10%;
			left: 2%;
			width: 45%;
			z-index: 99;
		}

		video {
			position: absolute;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			width: 100%;

			-moz-transform: scaleX(-1);
			-o-transform: scaleX(-1);
			-webkit-transform: scaleX(-1);
			transform: scaleX(-1);

		}


		h1 {
			position: absolute;
			font-size: 3em;
			width: 100%;
			margin: 0;
			padding: 0;
			bottom: 25%;
			text-align: center;
			font-weight: lighter;

		}

		h2 {
			position: absolute;
			bottom: 0;
			font-size: .8em;
			left: 0;
			z-index: 10;
			margin: 0 auto;
			padding: 0 0 .8em;
			width: 100%;
			text-align: center;
			font-weight: lighter;
		}

		#checkin {
			position: absolute;
			bottom: 0;
			width: 100%;
			height: 20%;
			left: 0;

			background: linear-gradient(transparent, rgba(0,0,0,.5)); /* Standard syntax */

		}

		#checkin label {
			display: block;
			margin: 1em auto;
			padding: 0;
			width: 95%;
		}

		#checkin input {
			display: block;
			position: relative;
			margin: 0 auto;
			width: 95%;
			outline: none;
			border: solid 1px #fff;
			padding: .2em;
			font-size: 3em;
			background-color: #fff;
		}




	</style>



	<img src="/img/gdgsaopaulo.png" alt="" id="logo" />
	<video id="v" autoplay></video>
	<h1></h1>
	<h2>Desenvolvido pelo GDG SÃ£o Paulo - Setembro/2013</h2>

	<div id="checkin">
		<label>mostre o QRCode para a webcam ou digite seu e-mail informado no cadastro e pressione &lt;ENTER&gt;</label>
		<input type="text" id="txtEmail"></input>
	</div>

	<canvas id="qr-canvas" width="800" height="600" style="display: none;"></canvas>
	<div id="outdiv"></div>







	<script src="/socket.io/socket.io.js"></script>
	<script src="http://code.jquery.com/jquery-1.10.1.min.js"></script>	

	<script src="/javascripts/llqrcode.js"></script>	
	<script src="/javascripts/webqr.js"></script>	





	<script type="text/javascript">

		var MENSAGEM_INICIAL = "Retire sua credencial aqui!";

		var socket = io.connect("http://"+location.hostname);

		socket.on("checkin result", function(data){
			console.log("CHECKIN RESULT!");
			if (data.socket_id != socket.socket.sessionid)
				return;
			showMessage(data.mensagem.replace("\n","<br/>"), 3000);
		});



		socket.on("message", function(mensagem){
			showMessage(mensagem.replace("\n","<br/>"), 3000);
		});


		var tmrShowCheckin = null;
		var tmrCapture = null;


		$(document).ready(function(){

			if(isCanvasSupported())
			{
				initCanvas(800,600);
				qrcode.callback = function(a) {	
					validateAttendee(a);
				};
			}

			$(document).keypress(function(e) {
				if(e.which == 13) {
					if (tmrShowCheckin) clearTimeout(tmrShowCheckin);
					if ($("#txtEmail").val() != "") {
						validateAttendee($("#txtEmail").val());
						$("#txtEmail").val("");
					} else {
						showCheckin();
					}
				} else {
					if (!$("#txtEmail").is(":focus"))
						$("#txtEmail").focus();
				}
			});

			setwebcam();
			showCheckin();

		});



		function validateAttendee(id) {
			if (id.trim().length == 0) return;

			//incluir informacao de indice do socket
			console.log("validando...", id);
			showMessage("aguarde...", 5000);
			socket.emit('checkin', id.toLowerCase());
		}

		function showCheckin() {
			console.log("voltei a reconhecer");
			captureToCanvas(); 

			showMessage(MENSAGEM_INICIAL);

			if (!$("#txtEmail").is(":focus"))
				$("#txtEmail").focus();
		}

		function showMessage(mensagem, timeoutactive){
			$("h1").empty().append(mensagem)
			if (timeoutactive)
				tmrShowCheckin = setTimeout(showCheckin, timeoutactive);

		}


    </script>
    


  </body>
</html>